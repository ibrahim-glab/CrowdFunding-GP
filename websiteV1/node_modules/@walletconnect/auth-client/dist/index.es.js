import{RELAYER_EVENTS as ve,PAIRING_EVENTS as Ae,Core as _e,Store as P}from"@walletconnect/core";import{pino as xe,getDefaultLoggerOptions as Re,generateChildLogger as Fe,getLoggerContext as Te}from"@walletconnect/logger";import{EventEmitter as Ie}from"events";import{formatJsonRpcRequest as qe,formatJsonRpcResult as Ue,formatJsonRpcError as Oe,isJsonRpcResult as Se,isJsonRpcError as Pe,isJsonRpcRequest as Ne,isJsonRpcResponse as $e}from"@walletconnect/jsonrpc-utils";import{isValidUrl as Be,isValidRequestExpiry as ze,getInternalError as k,hashKey as J,isBrowser as je,TYPE_1 as Me}from"@walletconnect/utils";import{ONE_DAY as N,FIVE_MINUTES as Le,SEVEN_DAYS as Ke}from"@walletconnect/time";import{hashMessage as X}from"@ethersproject/hash";import{recoverAddress as Ve}from"@ethersproject/transactions";import ke from"isomorphic-unfetch";import{randomStringForEntropy as Je}from"@stablelib/random";import{hash as Xe}from"@stablelib/sha256";class G{constructor(t){this.client=t}}class H{constructor(t){this.opts=t}}const Y="https://rpc.walletconnect.com/v1",R={wc_authRequest:{req:{ttl:N,prompt:!0,tag:3e3},res:{ttl:N,prompt:!1,tag:3001}}},U={min:Le,max:Ke},$="wc",Q=1,Z="auth",B="authClient",F=`${$}@${1}:${Z}:`,x=`${F}:PUB_KEY`,Ge="expirer",He={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Ye="0.3",Qe=N;function z(r){return r?.split(":")}function Ze(r){const t=r&&z(r);if(t)return t[3]}function We(r){const t=r&&z(r);if(t)return t[2]+":"+t[3]}function W(r){const t=r&&z(r);if(t)return t.pop()}async function et(r,t,e,i,n){switch(e.t){case"eip191":return tt(r,t,e.s);case"eip1271":return await rt(r,t,e.s,i,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${e.t}`)}}function tt(r,t,e){return Ve(X(t),e).toLowerCase()===r.toLowerCase()}async function rt(r,t,e,i,n){try{const s="0x1626ba7e",o="0000000000000000000000000000000000000000000000000000000000000040",u="0000000000000000000000000000000000000000000000000000000000000041",a=e.substring(2),c=X(t).substring(2),h=s+c+o+u+a,f=await ke(`${Y}/?chainId=${i}&projectId=${n}`,{method:"POST",body:JSON.stringify({id:it(),jsonrpc:"2.0",method:"eth_call",params:[{to:r,data:h},"latest"]})}),{result:p}=await f.json();return p?p.slice(0,s.length).toLowerCase()===s.toLowerCase():!1}catch(s){return console.error("isValidEip1271Signature: ",s),!1}}function it(){return Date.now()+Math.floor(Math.random()*1e3)}function ee(r){return r.getAll().filter(t=>"requester"in t)}function te(r,t){return ee(r).find(e=>e.id===t)}function nt(r){const t=Be(r.aud),e=new RegExp(`${r.domain}`).test(r.aud),i=!!r.nonce,n=r.type?r.type==="eip4361":!0,s=r.expiry;if(s&&!ze(s,U)){const{message:o}=k("MISSING_OR_INVALID",`request() expiry: ${s}. Expiry must be a number (in seconds) between ${U.min} and ${U.max}`);throw new Error(o)}return!!(t&&e&&i&&n)}function st(r,t){return!!te(t,r.id)}function ot(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}function ut(r,t){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),i=0;i<e.length;i++)e[i]=255;for(var n=0;n<r.length;n++){var s=r.charAt(n),o=s.charCodeAt(0);if(e[o]!==255)throw new TypeError(s+" is ambiguous");e[o]=n}var u=r.length,a=r.charAt(0),c=Math.log(u)/Math.log(256),h=Math.log(256)/Math.log(u);function f(D){if(D instanceof Uint8Array||(ArrayBuffer.isView(D)?D=new Uint8Array(D.buffer,D.byteOffset,D.byteLength):Array.isArray(D)&&(D=Uint8Array.from(D))),!(D instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(D.length===0)return"";for(var l=0,m=0,E=0,y=D.length;E!==y&&D[E]===0;)E++,l++;for(var w=(y-E)*h+1>>>0,g=new Uint8Array(w);E!==y;){for(var C=D[E],_=0,b=w-1;(C!==0||_<m)&&b!==-1;b--,_++)C+=256*g[b]>>>0,g[b]=C%u>>>0,C=C/u>>>0;if(C!==0)throw new Error("Non-zero carry");m=_,E++}for(var v=w-m;v!==w&&g[v]===0;)v++;for(var q=a.repeat(l);v<w;++v)q+=r.charAt(g[v]);return q}function p(D){if(typeof D!="string")throw new TypeError("Expected String");if(D.length===0)return new Uint8Array;var l=0;if(D[l]!==" "){for(var m=0,E=0;D[l]===a;)m++,l++;for(var y=(D.length-l)*c+1>>>0,w=new Uint8Array(y);D[l];){var g=e[D.charCodeAt(l)];if(g===255)return;for(var C=0,_=y-1;(g!==0||C<E)&&_!==-1;_--,C++)g+=u*w[_]>>>0,w[_]=g%256>>>0,g=g/256>>>0;if(g!==0)throw new Error("Non-zero carry");E=C,l++}if(D[l]!==" "){for(var b=y-E;b!==y&&w[b]===0;)b++;for(var v=new Uint8Array(m+(y-b)),q=m;b!==y;)v[q++]=w[b++];return v}}}function A(D){var l=p(D);if(l)return l;throw new Error(`Non-${t} character`)}return{encode:f,decodeUnsafe:p,decode:A}}var at=ut,Dt=at;const re=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},ct=r=>new TextEncoder().encode(r),ht=r=>new TextDecoder().decode(r);class lt{constructor(t,e,i){this.name=t,this.prefix=e,this.baseEncode=i}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}}class dt{constructor(t,e,i){if(this.name=t,this.prefix=e,e.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=e.codePointAt(0),this.baseDecode=i}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return ie(this,t)}}class pt{constructor(t){this.decoders=t}or(t){return ie(this,t)}decode(t){const e=t[0],i=this.decoders[e];if(i)return i.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const ie=(r,t)=>new pt({...r.decoders||{[r.prefix]:r},...t.decoders||{[t.prefix]:t}});class ft{constructor(t,e,i,n){this.name=t,this.prefix=e,this.baseEncode=i,this.baseDecode=n,this.encoder=new lt(t,e,i),this.decoder=new dt(t,e,n)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}}const O=({name:r,prefix:t,encode:e,decode:i})=>new ft(r,t,e,i),T=({prefix:r,name:t,alphabet:e})=>{const{encode:i,decode:n}=Dt(e,t);return O({prefix:r,name:t,encode:i,decode:s=>re(n(s))})},gt=(r,t,e,i)=>{const n={};for(let h=0;h<t.length;++h)n[t[h]]=h;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*e/8|0);let u=0,a=0,c=0;for(let h=0;h<s;++h){const f=n[r[h]];if(f===void 0)throw new SyntaxError(`Non-${i} character`);a=a<<e|f,u+=e,u>=8&&(u-=8,o[c++]=255&a>>u)}if(u>=e||255&a<<8-u)throw new SyntaxError("Unexpected end of data");return o},Et=(r,t,e)=>{const i=t[t.length-1]==="=",n=(1<<e)-1;let s="",o=0,u=0;for(let a=0;a<r.length;++a)for(u=u<<8|r[a],o+=8;o>e;)o-=e,s+=t[n&u>>o];if(o&&(s+=t[n&u<<e-o]),i)for(;s.length*e&7;)s+="=";return s},d=({name:r,prefix:t,bitsPerChar:e,alphabet:i})=>O({prefix:t,name:r,encode(n){return Et(n,i,e)},decode(n){return gt(n,i,e,r)}}),bt=O({prefix:"\0",name:"identity",encode:r=>ht(r),decode:r=>ct(r)});var yt=Object.freeze({__proto__:null,identity:bt});const wt=d({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Ct=Object.freeze({__proto__:null,base2:wt});const mt=d({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var vt=Object.freeze({__proto__:null,base8:mt});const At=T({prefix:"9",name:"base10",alphabet:"0123456789"});var _t=Object.freeze({__proto__:null,base10:At});const xt=d({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Rt=d({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var Ft=Object.freeze({__proto__:null,base16:xt,base16upper:Rt});const Tt=d({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),It=d({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),qt=d({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ut=d({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Ot=d({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),St=d({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Pt=d({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Nt=d({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),$t=d({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Bt=Object.freeze({__proto__:null,base32:Tt,base32upper:It,base32pad:qt,base32padupper:Ut,base32hex:Ot,base32hexupper:St,base32hexpad:Pt,base32hexpadupper:Nt,base32z:$t});const zt=T({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),jt=T({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Mt=Object.freeze({__proto__:null,base36:zt,base36upper:jt});const Lt=T({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Kt=T({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Vt=Object.freeze({__proto__:null,base58btc:Lt,base58flickr:Kt});const kt=d({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Jt=d({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Xt=d({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Gt=d({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Ht=Object.freeze({__proto__:null,base64:kt,base64pad:Jt,base64url:Xt,base64urlpad:Gt});const ne=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Yt=ne.reduce((r,t,e)=>(r[e]=t,r),[]),Qt=ne.reduce((r,t,e)=>(r[t.codePointAt(0)]=e,r),[]);function Zt(r){return r.reduce((t,e)=>(t+=Yt[e],t),"")}function Wt(r){const t=[];for(const e of r){const i=Qt[e.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${e}`);t.push(i)}return new Uint8Array(t)}const er=O({prefix:"\u{1F680}",name:"base256emoji",encode:Zt,decode:Wt});var tr=Object.freeze({__proto__:null,base256emoji:er}),rr=oe,se=128,ir=127,nr=~ir,sr=Math.pow(2,31);function oe(r,t,e){t=t||[],e=e||0;for(var i=e;r>=sr;)t[e++]=r&255|se,r/=128;for(;r&nr;)t[e++]=r&255|se,r>>>=7;return t[e]=r|0,oe.bytes=e-i+1,t}var or=j,ur=128,ue=127;function j(r,i){var e=0,i=i||0,n=0,s=i,o,u=r.length;do{if(s>=u)throw j.bytes=0,new RangeError("Could not decode varint");o=r[s++],e+=n<28?(o&ue)<<n:(o&ue)*Math.pow(2,n),n+=7}while(o>=ur);return j.bytes=s-i,e}var ar=Math.pow(2,7),Dr=Math.pow(2,14),cr=Math.pow(2,21),hr=Math.pow(2,28),lr=Math.pow(2,35),dr=Math.pow(2,42),pr=Math.pow(2,49),fr=Math.pow(2,56),gr=Math.pow(2,63),Er=function(r){return r<ar?1:r<Dr?2:r<cr?3:r<hr?4:r<lr?5:r<dr?6:r<pr?7:r<fr?8:r<gr?9:10},br={encode:rr,decode:or,encodingLength:Er},ae=br;const De=(r,t,e=0)=>(ae.encode(r,t,e),t),ce=r=>ae.encodingLength(r),M=(r,t)=>{const e=t.byteLength,i=ce(r),n=i+ce(e),s=new Uint8Array(n+e);return De(r,s,0),De(e,s,i),s.set(t,n),new yr(r,e,t,s)};class yr{constructor(t,e,i,n){this.code=t,this.size=e,this.digest=i,this.bytes=n}}const he=({name:r,code:t,encode:e})=>new wr(r,t,e);class wr{constructor(t,e,i){this.name=t,this.code=e,this.encode=i}digest(t){if(t instanceof Uint8Array){const e=this.encode(t);return e instanceof Uint8Array?M(this.code,e):e.then(i=>M(this.code,i))}else throw Error("Unknown type, must be binary type")}}const le=r=>async t=>new Uint8Array(await crypto.subtle.digest(r,t)),Cr=he({name:"sha2-256",code:18,encode:le("SHA-256")}),mr=he({name:"sha2-512",code:19,encode:le("SHA-512")});var vr=Object.freeze({__proto__:null,sha256:Cr,sha512:mr});const de=0,Ar="identity",pe=re,_r=r=>M(de,pe(r)),xr={code:de,name:Ar,encode:pe,digest:_r};var Rr=Object.freeze({__proto__:null,identity:xr});new TextEncoder,new TextDecoder;const fe={...yt,...Ct,...vt,..._t,...Ft,...Bt,...Mt,...Vt,...Ht,...tr};({...vr,...Rr});function ge(r,t,e,i){return{name:r,prefix:t,encoder:{name:r,prefix:t,encode:e},decoder:{decode:i}}}const Ee=ge("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),L=ge("ascii","a",r=>{let t="a";for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return t},r=>{r=r.substring(1);const t=ot(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}),be={utf8:Ee,"utf-8":Ee,hex:fe.base16,latin1:L,ascii:L,binary:L,...fe};function Fr(r,t="utf8"){const e=be[t];if(!e)throw new Error(`Unsupported encoding "${t}"`);return(t==="utf8"||t==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r,"utf8"):e.decoder.decode(`${e.prefix}${r}`)}function Tr(r,t="utf8"){const e=be[t];if(!e)throw new Error(`Unsupported encoding "${t}"`);return(t==="utf8"||t==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):e.encoder.encode(r).substring(1)}const Ir="base10",ye="base16",qr="base64pad",we="utf8";function Ur(){return Je(96)}function K(r){const t=Xe(Fr(r,we));return Tr(t,ye)}var Or=Object.defineProperty,Sr=Object.defineProperties,Pr=Object.getOwnPropertyDescriptors,Ce=Object.getOwnPropertySymbols,Nr=Object.prototype.hasOwnProperty,$r=Object.prototype.propertyIsEnumerable,me=(r,t,e)=>t in r?Or(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,I=(r,t)=>{for(var e in t||(t={}))Nr.call(t,e)&&me(r,e,t[e]);if(Ce)for(var e of Ce(t))$r.call(t,e)&&me(r,e,t[e]);return r},V=(r,t)=>Sr(r,Pr(t));class Br extends G{constructor(t){super(t),this.initialized=!1,this.name="authEngine",this.init=()=>{this.initialized||(this.registerRelayerEvents(),this.registerPairingEvents(),this.client.core.pairing.register({methods:Object.keys(R)}),this.initialized=!0)},this.request=async(e,i)=>{if(this.isInitialized(),!nt(e))throw new Error("Invalid request");if(i!=null&&i.topic)return await this.requestOnKnownPairing(i.topic,e);const{chainId:n,statement:s,aud:o,domain:u,nonce:a,type:c,exp:h,nbf:f}=e,{topic:p,uri:A}=await this.client.core.pairing.create();this.client.logger.info({message:"Generated new pairing",pairing:{topic:p,uri:A}});const D=await this.client.core.crypto.generateKeyPair(),l=J(D);await this.client.authKeys.set(x,{responseTopic:l,publicKey:D}),await this.client.pairingTopics.set(l,{topic:l,pairingTopic:p}),await this.client.core.relayer.subscribe(l),this.client.logger.info(`sending request to new pairing topic: ${p}`);const m=await this.sendRequest(p,"wc_authRequest",{payloadParams:{type:c??"eip4361",chainId:n,statement:s,aud:o,domain:u,version:"1",nonce:a,iat:new Date().toISOString(),exp:h,nbf:f},requester:{publicKey:D,metadata:this.client.metadata}},{},e.expiry);return this.client.logger.info(`sent request to new pairing topic: ${p}`),{uri:A,id:m}},this.respond=async(e,i)=>{if(this.isInitialized(),!st(e,this.client.requests))throw new Error("Invalid response");const n=te(this.client.requests,e.id);if(!n)throw new Error(`Could not find pending auth request with id ${e.id}`);const s=n.requester.publicKey,o=await this.client.core.crypto.generateKeyPair(),u=J(s),a={type:Me,receiverPublicKey:s,senderPublicKey:o};if("error"in e){await this.sendError(n.id,u,e,a);return}const c={h:{t:"eip4361"},p:V(I({},n.cacaoPayload),{iss:i}),s:e.signature};await this.sendResult(n.id,u,c,a),await this.client.core.pairing.activate({topic:n.pairingTopic}),await this.client.requests.update(n.id,I({},c))},this.getPendingRequests=()=>ee(this.client.requests),this.formatMessage=(e,i)=>{this.client.logger.debug(`formatMessage, cacao is: ${JSON.stringify(e)}`);const n=`${e.domain} wants you to sign in with your Ethereum account:`,s=W(i),o=e.statement,u=`URI: ${e.aud}`,a=`Version: ${e.version}`,c=`Chain ID: ${Ze(i)}`,h=`Nonce: ${e.nonce}`,f=`Issued At: ${e.iat}`,p=e.exp?`Expiry: ${e.exp}`:void 0,A=e.resources&&e.resources.length>0?`Resources:
${e.resources.map(D=>`- ${D}`).join(`
`)}`:void 0;return[n,s,"",o,"",u,a,c,h,f,p,A].filter(D=>D!=null).join(`
`)},this.setExpiry=async(e,i)=>{this.client.core.pairing.pairings.keys.includes(e)&&await this.client.core.pairing.updateExpiry({topic:e,expiry:i}),this.client.core.expirer.set(e,i)},this.sendRequest=async(e,i,n,s,o)=>{const u=qe(i,n),a=await this.client.core.crypto.encode(e,u,s),c=R[i].req;if(o&&(c.ttl=o),this.client.core.history.set(e,u),je()){const h=K(JSON.stringify(u));this.client.core.verify.register({attestationId:h})}return await this.client.core.relayer.publish(e,a,V(I({},c),{internal:{throwOnFailedPublish:!0}})),u.id},this.sendResult=async(e,i,n,s)=>{const o=Ue(e,n),u=await this.client.core.crypto.encode(i,o,s),a=await this.client.core.history.get(i,e),c=R[a.request.method].res;return await this.client.core.relayer.publish(i,u,V(I({},c),{internal:{throwOnFailedPublish:!0}})),await this.client.core.history.resolve(o),o.id},this.sendError=async(e,i,n,s)=>{const o=Oe(e,n.error),u=await this.client.core.crypto.encode(i,o,s),a=await this.client.core.history.get(i,e),c=R[a.request.method].res;return await this.client.core.relayer.publish(i,u,c),await this.client.core.history.resolve(o),o.id},this.requestOnKnownPairing=async(e,i)=>{const n=this.client.core.pairing.pairings.getAll({active:!0}).find(A=>A.topic===e);if(!n)throw new Error(`Could not find pairing for provided topic ${e}`);const{publicKey:s}=this.client.authKeys.get(x),{chainId:o,statement:u,aud:a,domain:c,nonce:h,type:f}=i,p=await this.sendRequest(n.topic,"wc_authRequest",{payloadParams:{type:f??"eip4361",chainId:o,statement:u,aud:a,domain:c,version:"1",nonce:h,iat:new Date().toISOString()},requester:{publicKey:s,metadata:this.client.metadata}},{},i.expiry);return this.client.logger.info(`sent request to known pairing topic: ${n.topic}`),{id:p}},this.onPairingCreated=e=>{const i=this.getPendingRequests();if(i){const n=Object.values(i).find(s=>s.pairingTopic===e.topic);n&&this.handleAuthRequest(n)}},this.onRelayEventRequest=e=>{const{topic:i,payload:n}=e,s=n.method;switch(s){case"wc_authRequest":return this.onAuthRequest(i,n);default:return this.client.logger.info(`Unsupported request method ${s}`)}},this.onRelayEventResponse=async e=>{const{topic:i,payload:n}=e,s=(await this.client.core.history.get(i,n.id)).request.method;switch(s){case"wc_authRequest":return this.onAuthResponse(i,n);default:return this.client.logger.info(`Unsupported response method ${s}`)}},this.onAuthRequest=async(e,i)=>{const{requester:n,payloadParams:s}=i.params;this.client.logger.info({type:"onAuthRequest",topic:e,payload:i});const o=K(JSON.stringify(i)),u=await this.getVerifyContext(o,this.client.metadata),a={requester:n,pairingTopic:e,id:i.id,cacaoPayload:s,verifyContext:u};await this.client.requests.set(i.id,a),this.handleAuthRequest(a)},this.handleAuthRequest=async e=>{const{id:i,pairingTopic:n,requester:s,cacaoPayload:o,verifyContext:u}=e;try{this.client.emit("auth_request",{id:i,topic:n,params:{requester:s,cacaoPayload:o},verifyContext:u})}catch(a){await this.sendError(e.id,e.pairingTopic,a),this.client.logger.error(a)}},this.onAuthResponse=async(e,i)=>{const{id:n}=i;if(this.client.logger.info({type:"onAuthResponse",topic:e,response:i}),Se(i)){const{pairingTopic:s}=this.client.pairingTopics.get(e);await this.client.core.pairing.activate({topic:s});const{s:o,p:u}=i.result;await this.client.requests.set(n,I({id:n,pairingTopic:s},i.result));const a=this.formatMessage(u,u.iss);this.client.logger.debug(`reconstructed message:
`,JSON.stringify(a)),this.client.logger.debug("payload.iss:",u.iss),this.client.logger.debug("signature:",o);const c=W(u.iss),h=We(u.iss);if(!c)throw new Error("Could not derive address from `payload.iss`");if(!h)throw new Error("Could not derive chainId from `payload.iss`");this.client.logger.debug("walletAddress extracted from `payload.iss`:",c),await et(c,a,o,h,this.client.projectId)?this.client.emit("auth_response",{id:n,topic:e,params:i}):this.client.emit("auth_response",{id:n,topic:e,params:{message:"Invalid signature",code:-1}})}else Pe(i)&&this.client.emit("auth_response",{id:n,topic:e,params:i})},this.getVerifyContext=async(e,i)=>{const n={verified:{verifyUrl:i.verifyUrl||"",validation:"UNKNOWN",origin:i.url||""}};try{const s=await this.client.core.verify.resolve({attestationId:e,verifyUrl:i.verifyUrl});s&&(n.verified.origin=s.origin,n.verified.isScam=s.isScam,n.verified.validation=origin===new URL(i.url).origin?"VALID":"INVALID")}catch(s){this.client.logger.error(s)}return this.client.logger.info(`Verify context: ${JSON.stringify(n)}`),n}}isInitialized(){if(!this.initialized){const{message:t}=k("NOT_INITIALIZED",this.name);throw new Error(t)}}registerRelayerEvents(){this.client.core.relayer.on(ve.message,async t=>{const{topic:e,message:i}=t,{responseTopic:n,publicKey:s}=this.client.authKeys.keys.includes(x)?this.client.authKeys.get(x):{responseTopic:void 0,publicKey:void 0};if(n&&e!==n){this.client.logger.debug("[Auth] Ignoring message from unknown topic",e);return}const o=await this.client.core.crypto.decode(e,i,{receiverPublicKey:s});Ne(o)?(this.client.core.history.set(e,o),this.onRelayEventRequest({topic:e,payload:o})):$e(o)&&(await this.client.core.history.resolve(o),this.onRelayEventResponse({topic:e,payload:o}))})}registerPairingEvents(){this.client.core.pairing.events.on(Ae.create,t=>this.onPairingCreated(t))}}class S extends H{constructor(t){super(t),this.protocol=$,this.version=Q,this.name=B,this.events=new Ie,this.emit=(i,n)=>this.events.emit(i,n),this.on=(i,n)=>this.events.on(i,n),this.once=(i,n)=>this.events.once(i,n),this.off=(i,n)=>this.events.off(i,n),this.removeListener=(i,n)=>this.events.removeListener(i,n),this.request=async(i,n)=>{try{return await this.engine.request(i,n)}catch(s){throw this.logger.error(s.message),s}},this.respond=async(i,n)=>{try{return await this.engine.respond(i,n)}catch(s){throw this.logger.error(s.message),s}},this.getPendingRequests=()=>{try{return this.engine.getPendingRequests()}catch(i){throw this.logger.error(i.message),i}},this.formatMessage=(i,n)=>{try{return this.engine.formatMessage(i,n)}catch(s){throw this.logger.error(s.message),s}};const e=typeof t.logger<"u"&&typeof t.logger!="string"?t.logger:xe(Re({level:t.logger||"error"}));this.name=t?.name||B,this.metadata=t.metadata,this.projectId=t.projectId,this.core=t.core||new _e(t),this.logger=Fe(e,this.name),this.authKeys=new P(this.core,this.logger,"authKeys",F,()=>x),this.pairingTopics=new P(this.core,this.logger,"pairingTopics",F),this.requests=new P(this.core,this.logger,"requests",F,i=>i.id),this.engine=new Br(this)}static async init(t){const e=new S(t);return await e.initialize(),e}get context(){return Te(this.logger)}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.authKeys.init(),await this.requests.init(),await this.pairingTopics.init(),await this.engine.init(),this.logger.info("AuthClient Initialization Success"),this.logger.info({authClient:this})}catch(t){throw this.logger.info("AuthClient Initialization Failure"),this.logger.error(t.message),t}}}const zr=S;export{Z as AUTH_CLIENT_CONTEXT,B as AUTH_CLIENT_DEFAULT_NAME,$ as AUTH_CLIENT_PROTOCOL,x as AUTH_CLIENT_PUBLIC_KEY_NAME,F as AUTH_CLIENT_STORAGE_PREFIX,Q as AUTH_CLIENT_VERSION,U as AUTH_REQUEST_EXPIRY_BOUNDARIES,zr as AuthClient,Ir as BASE10,ye as BASE16,qr as BASE64,Y as DEFAULT_RPC_URL,R as ENGINE_RPC_OPTS,Ge as EXPIRER_CONTEXT,Qe as EXPIRER_DEFAULT_TTL,He as EXPIRER_EVENTS,Ye as EXPIRER_STORAGE_VERSION,H as IAuthClient,G as IAuthEngine,we as UTF8,S as default,Ur as generateNonce,K as hashMessage};
//# sourceMappingURL=index.es.js.map

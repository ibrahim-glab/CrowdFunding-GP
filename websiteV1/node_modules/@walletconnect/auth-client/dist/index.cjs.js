"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var x=require("@walletconnect/core"),P=require("@walletconnect/logger"),me=require("events"),T=require("@walletconnect/jsonrpc-utils"),R=require("@walletconnect/utils"),F=require("@walletconnect/time"),H=require("@ethersproject/hash"),_e=require("@ethersproject/transactions"),Re=require("isomorphic-unfetch"),Te=require("@stablelib/random"),xe=require("@stablelib/sha256");function Ie(r){return r&&typeof r=="object"&&"default"in r?r:{default:r}}var Fe=Ie(Re);class G{constructor(t){this.client=t}}class Y{constructor(t){this.opts=t}}const Q="https://rpc.walletconnect.com/v1",U={wc_authRequest:{req:{ttl:F.ONE_DAY,prompt:!0,tag:3e3},res:{ttl:F.ONE_DAY,prompt:!1,tag:3001}}},B={min:F.FIVE_MINUTES,max:F.SEVEN_DAYS},M="wc",Z=1,W="auth",j="authClient",N=`${M}@${1}:${W}:`,I=`${N}:PUB_KEY`,Ue="expirer",Ne={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Oe="0.3",Se=F.ONE_DAY;function z(r){return r?.split(":")}function qe(r){const t=r&&z(r);if(t)return t[3]}function Pe(r){const t=r&&z(r);if(t)return t[2]+":"+t[3]}function ee(r){const t=r&&z(r);if(t)return t.pop()}async function Be(r,t,e,i,n){switch(e.t){case"eip191":return $e(r,t,e.s);case"eip1271":return await Le(r,t,e.s,i,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${e.t}`)}}function $e(r,t,e){return _e.recoverAddress(H.hashMessage(t),e).toLowerCase()===r.toLowerCase()}async function Le(r,t,e,i,n){try{const s="0x1626ba7e",u="0000000000000000000000000000000000000000000000000000000000000040",a="0000000000000000000000000000000000000000000000000000000000000041",o=e.substring(2),c=H.hashMessage(t).substring(2),h=s+c+u+a+o,f=await Fe.default(`${Q}/?chainId=${i}&projectId=${n}`,{method:"POST",body:JSON.stringify({id:Me(),jsonrpc:"2.0",method:"eth_call",params:[{to:r,data:h},"latest"]})}),{result:p}=await f.json();return p?p.slice(0,s.length).toLowerCase()===s.toLowerCase():!1}catch(s){return console.error("isValidEip1271Signature: ",s),!1}}function Me(){return Date.now()+Math.floor(Math.random()*1e3)}function te(r){return r.getAll().filter(t=>"requester"in t)}function re(r,t){return te(r).find(e=>e.id===t)}function je(r){const t=R.isValidUrl(r.aud),e=new RegExp(`${r.domain}`).test(r.aud),i=!!r.nonce,n=r.type?r.type==="eip4361":!0,s=r.expiry;if(s&&!R.isValidRequestExpiry(s,B)){const{message:u}=R.getInternalError("MISSING_OR_INVALID",`request() expiry: ${s}. Expiry must be a number (in seconds) between ${B.min} and ${B.max}`);throw new Error(u)}return!!(t&&e&&i&&n)}function ze(r,t){return!!re(t,r.id)}function Ke(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}function Ve(r,t){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),i=0;i<e.length;i++)e[i]=255;for(var n=0;n<r.length;n++){var s=r.charAt(n),u=s.charCodeAt(0);if(e[u]!==255)throw new TypeError(s+" is ambiguous");e[u]=n}var a=r.length,o=r.charAt(0),c=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function f(D){if(D instanceof Uint8Array||(ArrayBuffer.isView(D)?D=new Uint8Array(D.buffer,D.byteOffset,D.byteLength):Array.isArray(D)&&(D=Uint8Array.from(D))),!(D instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(D.length===0)return"";for(var l=0,v=0,E=0,y=D.length;E!==y&&D[E]===0;)E++,l++;for(var C=(y-E)*h+1>>>0,g=new Uint8Array(C);E!==y;){for(var w=D[E],_=0,b=C-1;(w!==0||_<v)&&b!==-1;b--,_++)w+=256*g[b]>>>0,g[b]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");v=_,E++}for(var A=C-v;A!==C&&g[A]===0;)A++;for(var q=o.repeat(l);A<C;++A)q+=r.charAt(g[A]);return q}function p(D){if(typeof D!="string")throw new TypeError("Expected String");if(D.length===0)return new Uint8Array;var l=0;if(D[l]!==" "){for(var v=0,E=0;D[l]===o;)v++,l++;for(var y=(D.length-l)*c+1>>>0,C=new Uint8Array(y);D[l];){var g=e[D.charCodeAt(l)];if(g===255)return;for(var w=0,_=y-1;(g!==0||w<E)&&_!==-1;_--,w++)g+=a*C[_]>>>0,C[_]=g%256>>>0,g=g/256>>>0;if(g!==0)throw new Error("Non-zero carry");E=w,l++}if(D[l]!==" "){for(var b=y-E;b!==y&&C[b]===0;)b++;for(var A=new Uint8Array(v+(y-b)),q=v;b!==y;)A[q++]=C[b++];return A}}}function m(D){var l=p(D);if(l)return l;throw new Error(`Non-${t} character`)}return{encode:f,decodeUnsafe:p,decode:m}}var ke=Ve,Xe=ke;const ie=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Je=r=>new TextEncoder().encode(r),He=r=>new TextDecoder().decode(r);class Ge{constructor(t,e,i){this.name=t,this.prefix=e,this.baseEncode=i}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}}class Ye{constructor(t,e,i){if(this.name=t,this.prefix=e,e.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=e.codePointAt(0),this.baseDecode=i}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return ne(this,t)}}class Qe{constructor(t){this.decoders=t}or(t){return ne(this,t)}decode(t){const e=t[0],i=this.decoders[e];if(i)return i.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const ne=(r,t)=>new Qe({...r.decoders||{[r.prefix]:r},...t.decoders||{[t.prefix]:t}});class Ze{constructor(t,e,i,n){this.name=t,this.prefix=e,this.baseEncode=i,this.baseDecode=n,this.encoder=new Ge(t,e,i),this.decoder=new Ye(t,e,n)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}}const $=({name:r,prefix:t,encode:e,decode:i})=>new Ze(r,t,e,i),O=({prefix:r,name:t,alphabet:e})=>{const{encode:i,decode:n}=Xe(e,t);return $({prefix:r,name:t,encode:i,decode:s=>ie(n(s))})},We=(r,t,e,i)=>{const n={};for(let h=0;h<t.length;++h)n[t[h]]=h;let s=r.length;for(;r[s-1]==="=";)--s;const u=new Uint8Array(s*e/8|0);let a=0,o=0,c=0;for(let h=0;h<s;++h){const f=n[r[h]];if(f===void 0)throw new SyntaxError(`Non-${i} character`);o=o<<e|f,a+=e,a>=8&&(a-=8,u[c++]=255&o>>a)}if(a>=e||255&o<<8-a)throw new SyntaxError("Unexpected end of data");return u},et=(r,t,e)=>{const i=t[t.length-1]==="=",n=(1<<e)-1;let s="",u=0,a=0;for(let o=0;o<r.length;++o)for(a=a<<8|r[o],u+=8;u>e;)u-=e,s+=t[n&a>>u];if(u&&(s+=t[n&a<<e-u]),i)for(;s.length*e&7;)s+="=";return s},d=({name:r,prefix:t,bitsPerChar:e,alphabet:i})=>$({prefix:t,name:r,encode(n){return et(n,i,e)},decode(n){return We(n,i,e,r)}}),tt=$({prefix:"\0",name:"identity",encode:r=>He(r),decode:r=>Je(r)});var rt=Object.freeze({__proto__:null,identity:tt});const it=d({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var nt=Object.freeze({__proto__:null,base2:it});const st=d({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var ut=Object.freeze({__proto__:null,base8:st});const at=O({prefix:"9",name:"base10",alphabet:"0123456789"});var ot=Object.freeze({__proto__:null,base10:at});const Dt=d({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ct=d({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ht=Object.freeze({__proto__:null,base16:Dt,base16upper:ct});const lt=d({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),dt=d({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),pt=d({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ft=d({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),gt=d({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Et=d({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),bt=d({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),yt=d({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Ct=d({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var wt=Object.freeze({__proto__:null,base32:lt,base32upper:dt,base32pad:pt,base32padupper:ft,base32hex:gt,base32hexupper:Et,base32hexpad:bt,base32hexpadupper:yt,base32z:Ct});const vt=O({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),At=O({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var mt=Object.freeze({__proto__:null,base36:vt,base36upper:At});const _t=O({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Rt=O({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Tt=Object.freeze({__proto__:null,base58btc:_t,base58flickr:Rt});const xt=d({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),It=d({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Ft=d({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ut=d({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Nt=Object.freeze({__proto__:null,base64:xt,base64pad:It,base64url:Ft,base64urlpad:Ut});const se=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),Ot=se.reduce((r,t,e)=>(r[e]=t,r),[]),St=se.reduce((r,t,e)=>(r[t.codePointAt(0)]=e,r),[]);function qt(r){return r.reduce((t,e)=>(t+=Ot[e],t),"")}function Pt(r){const t=[];for(const e of r){const i=St[e.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${e}`);t.push(i)}return new Uint8Array(t)}const Bt=$({prefix:"\u{1F680}",name:"base256emoji",encode:qt,decode:Pt});var $t=Object.freeze({__proto__:null,base256emoji:Bt}),Lt=ae,ue=128,Mt=127,jt=~Mt,zt=Math.pow(2,31);function ae(r,t,e){t=t||[],e=e||0;for(var i=e;r>=zt;)t[e++]=r&255|ue,r/=128;for(;r&jt;)t[e++]=r&255|ue,r>>>=7;return t[e]=r|0,ae.bytes=e-i+1,t}var Kt=K,Vt=128,oe=127;function K(r,i){var e=0,i=i||0,n=0,s=i,u,a=r.length;do{if(s>=a)throw K.bytes=0,new RangeError("Could not decode varint");u=r[s++],e+=n<28?(u&oe)<<n:(u&oe)*Math.pow(2,n),n+=7}while(u>=Vt);return K.bytes=s-i,e}var kt=Math.pow(2,7),Xt=Math.pow(2,14),Jt=Math.pow(2,21),Ht=Math.pow(2,28),Gt=Math.pow(2,35),Yt=Math.pow(2,42),Qt=Math.pow(2,49),Zt=Math.pow(2,56),Wt=Math.pow(2,63),er=function(r){return r<kt?1:r<Xt?2:r<Jt?3:r<Ht?4:r<Gt?5:r<Yt?6:r<Qt?7:r<Zt?8:r<Wt?9:10},tr={encode:Lt,decode:Kt,encodingLength:er},De=tr;const ce=(r,t,e=0)=>(De.encode(r,t,e),t),he=r=>De.encodingLength(r),V=(r,t)=>{const e=t.byteLength,i=he(r),n=i+he(e),s=new Uint8Array(n+e);return ce(r,s,0),ce(e,s,i),s.set(t,n),new rr(r,e,t,s)};class rr{constructor(t,e,i,n){this.code=t,this.size=e,this.digest=i,this.bytes=n}}const le=({name:r,code:t,encode:e})=>new ir(r,t,e);class ir{constructor(t,e,i){this.name=t,this.code=e,this.encode=i}digest(t){if(t instanceof Uint8Array){const e=this.encode(t);return e instanceof Uint8Array?V(this.code,e):e.then(i=>V(this.code,i))}else throw Error("Unknown type, must be binary type")}}const de=r=>async t=>new Uint8Array(await crypto.subtle.digest(r,t)),nr=le({name:"sha2-256",code:18,encode:de("SHA-256")}),sr=le({name:"sha2-512",code:19,encode:de("SHA-512")});var ur=Object.freeze({__proto__:null,sha256:nr,sha512:sr});const pe=0,ar="identity",fe=ie,or=r=>V(pe,fe(r)),Dr={code:pe,name:ar,encode:fe,digest:or};var cr=Object.freeze({__proto__:null,identity:Dr});new TextEncoder,new TextDecoder;const ge={...rt,...nt,...ut,...ot,...ht,...wt,...mt,...Tt,...Nt,...$t};({...ur,...cr});function Ee(r,t,e,i){return{name:r,prefix:t,encoder:{name:r,prefix:t,encode:e},decoder:{decode:i}}}const be=Ee("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),k=Ee("ascii","a",r=>{let t="a";for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return t},r=>{r=r.substring(1);const t=Ke(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}),ye={utf8:be,"utf-8":be,hex:ge.base16,latin1:k,ascii:k,binary:k,...ge};function hr(r,t="utf8"){const e=ye[t];if(!e)throw new Error(`Unsupported encoding "${t}"`);return(t==="utf8"||t==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r,"utf8"):e.decoder.decode(`${e.prefix}${r}`)}function lr(r,t="utf8"){const e=ye[t];if(!e)throw new Error(`Unsupported encoding "${t}"`);return(t==="utf8"||t==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):e.encoder.encode(r).substring(1)}const dr="base10",Ce="base16",pr="base64pad",we="utf8";function fr(){return Te.randomStringForEntropy(96)}function X(r){const t=xe.hash(hr(r,we));return lr(t,Ce)}var gr=Object.defineProperty,Er=Object.defineProperties,br=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertySymbols,yr=Object.prototype.hasOwnProperty,Cr=Object.prototype.propertyIsEnumerable,Ae=(r,t,e)=>t in r?gr(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,S=(r,t)=>{for(var e in t||(t={}))yr.call(t,e)&&Ae(r,e,t[e]);if(ve)for(var e of ve(t))Cr.call(t,e)&&Ae(r,e,t[e]);return r},J=(r,t)=>Er(r,br(t));class wr extends G{constructor(t){super(t),this.initialized=!1,this.name="authEngine",this.init=()=>{this.initialized||(this.registerRelayerEvents(),this.registerPairingEvents(),this.client.core.pairing.register({methods:Object.keys(U)}),this.initialized=!0)},this.request=async(e,i)=>{if(this.isInitialized(),!je(e))throw new Error("Invalid request");if(i!=null&&i.topic)return await this.requestOnKnownPairing(i.topic,e);const{chainId:n,statement:s,aud:u,domain:a,nonce:o,type:c,exp:h,nbf:f}=e,{topic:p,uri:m}=await this.client.core.pairing.create();this.client.logger.info({message:"Generated new pairing",pairing:{topic:p,uri:m}});const D=await this.client.core.crypto.generateKeyPair(),l=R.hashKey(D);await this.client.authKeys.set(I,{responseTopic:l,publicKey:D}),await this.client.pairingTopics.set(l,{topic:l,pairingTopic:p}),await this.client.core.relayer.subscribe(l),this.client.logger.info(`sending request to new pairing topic: ${p}`);const v=await this.sendRequest(p,"wc_authRequest",{payloadParams:{type:c??"eip4361",chainId:n,statement:s,aud:u,domain:a,version:"1",nonce:o,iat:new Date().toISOString(),exp:h,nbf:f},requester:{publicKey:D,metadata:this.client.metadata}},{},e.expiry);return this.client.logger.info(`sent request to new pairing topic: ${p}`),{uri:m,id:v}},this.respond=async(e,i)=>{if(this.isInitialized(),!ze(e,this.client.requests))throw new Error("Invalid response");const n=re(this.client.requests,e.id);if(!n)throw new Error(`Could not find pending auth request with id ${e.id}`);const s=n.requester.publicKey,u=await this.client.core.crypto.generateKeyPair(),a=R.hashKey(s),o={type:R.TYPE_1,receiverPublicKey:s,senderPublicKey:u};if("error"in e){await this.sendError(n.id,a,e,o);return}const c={h:{t:"eip4361"},p:J(S({},n.cacaoPayload),{iss:i}),s:e.signature};await this.sendResult(n.id,a,c,o),await this.client.core.pairing.activate({topic:n.pairingTopic}),await this.client.requests.update(n.id,S({},c))},this.getPendingRequests=()=>te(this.client.requests),this.formatMessage=(e,i)=>{this.client.logger.debug(`formatMessage, cacao is: ${JSON.stringify(e)}`);const n=`${e.domain} wants you to sign in with your Ethereum account:`,s=ee(i),u=e.statement,a=`URI: ${e.aud}`,o=`Version: ${e.version}`,c=`Chain ID: ${qe(i)}`,h=`Nonce: ${e.nonce}`,f=`Issued At: ${e.iat}`,p=e.exp?`Expiry: ${e.exp}`:void 0,m=e.resources&&e.resources.length>0?`Resources:
${e.resources.map(D=>`- ${D}`).join(`
`)}`:void 0;return[n,s,"",u,"",a,o,c,h,f,p,m].filter(D=>D!=null).join(`
`)},this.setExpiry=async(e,i)=>{this.client.core.pairing.pairings.keys.includes(e)&&await this.client.core.pairing.updateExpiry({topic:e,expiry:i}),this.client.core.expirer.set(e,i)},this.sendRequest=async(e,i,n,s,u)=>{const a=T.formatJsonRpcRequest(i,n),o=await this.client.core.crypto.encode(e,a,s),c=U[i].req;if(u&&(c.ttl=u),this.client.core.history.set(e,a),R.isBrowser()){const h=X(JSON.stringify(a));this.client.core.verify.register({attestationId:h})}return await this.client.core.relayer.publish(e,o,J(S({},c),{internal:{throwOnFailedPublish:!0}})),a.id},this.sendResult=async(e,i,n,s)=>{const u=T.formatJsonRpcResult(e,n),a=await this.client.core.crypto.encode(i,u,s),o=await this.client.core.history.get(i,e),c=U[o.request.method].res;return await this.client.core.relayer.publish(i,a,J(S({},c),{internal:{throwOnFailedPublish:!0}})),await this.client.core.history.resolve(u),u.id},this.sendError=async(e,i,n,s)=>{const u=T.formatJsonRpcError(e,n.error),a=await this.client.core.crypto.encode(i,u,s),o=await this.client.core.history.get(i,e),c=U[o.request.method].res;return await this.client.core.relayer.publish(i,a,c),await this.client.core.history.resolve(u),u.id},this.requestOnKnownPairing=async(e,i)=>{const n=this.client.core.pairing.pairings.getAll({active:!0}).find(m=>m.topic===e);if(!n)throw new Error(`Could not find pairing for provided topic ${e}`);const{publicKey:s}=this.client.authKeys.get(I),{chainId:u,statement:a,aud:o,domain:c,nonce:h,type:f}=i,p=await this.sendRequest(n.topic,"wc_authRequest",{payloadParams:{type:f??"eip4361",chainId:u,statement:a,aud:o,domain:c,version:"1",nonce:h,iat:new Date().toISOString()},requester:{publicKey:s,metadata:this.client.metadata}},{},i.expiry);return this.client.logger.info(`sent request to known pairing topic: ${n.topic}`),{id:p}},this.onPairingCreated=e=>{const i=this.getPendingRequests();if(i){const n=Object.values(i).find(s=>s.pairingTopic===e.topic);n&&this.handleAuthRequest(n)}},this.onRelayEventRequest=e=>{const{topic:i,payload:n}=e,s=n.method;switch(s){case"wc_authRequest":return this.onAuthRequest(i,n);default:return this.client.logger.info(`Unsupported request method ${s}`)}},this.onRelayEventResponse=async e=>{const{topic:i,payload:n}=e,s=(await this.client.core.history.get(i,n.id)).request.method;switch(s){case"wc_authRequest":return this.onAuthResponse(i,n);default:return this.client.logger.info(`Unsupported response method ${s}`)}},this.onAuthRequest=async(e,i)=>{const{requester:n,payloadParams:s}=i.params;this.client.logger.info({type:"onAuthRequest",topic:e,payload:i});const u=X(JSON.stringify(i)),a=await this.getVerifyContext(u,this.client.metadata),o={requester:n,pairingTopic:e,id:i.id,cacaoPayload:s,verifyContext:a};await this.client.requests.set(i.id,o),this.handleAuthRequest(o)},this.handleAuthRequest=async e=>{const{id:i,pairingTopic:n,requester:s,cacaoPayload:u,verifyContext:a}=e;try{this.client.emit("auth_request",{id:i,topic:n,params:{requester:s,cacaoPayload:u},verifyContext:a})}catch(o){await this.sendError(e.id,e.pairingTopic,o),this.client.logger.error(o)}},this.onAuthResponse=async(e,i)=>{const{id:n}=i;if(this.client.logger.info({type:"onAuthResponse",topic:e,response:i}),T.isJsonRpcResult(i)){const{pairingTopic:s}=this.client.pairingTopics.get(e);await this.client.core.pairing.activate({topic:s});const{s:u,p:a}=i.result;await this.client.requests.set(n,S({id:n,pairingTopic:s},i.result));const o=this.formatMessage(a,a.iss);this.client.logger.debug(`reconstructed message:
`,JSON.stringify(o)),this.client.logger.debug("payload.iss:",a.iss),this.client.logger.debug("signature:",u);const c=ee(a.iss),h=Pe(a.iss);if(!c)throw new Error("Could not derive address from `payload.iss`");if(!h)throw new Error("Could not derive chainId from `payload.iss`");this.client.logger.debug("walletAddress extracted from `payload.iss`:",c),await Be(c,o,u,h,this.client.projectId)?this.client.emit("auth_response",{id:n,topic:e,params:i}):this.client.emit("auth_response",{id:n,topic:e,params:{message:"Invalid signature",code:-1}})}else T.isJsonRpcError(i)&&this.client.emit("auth_response",{id:n,topic:e,params:i})},this.getVerifyContext=async(e,i)=>{const n={verified:{verifyUrl:i.verifyUrl||"",validation:"UNKNOWN",origin:i.url||""}};try{const s=await this.client.core.verify.resolve({attestationId:e,verifyUrl:i.verifyUrl});s&&(n.verified.origin=s.origin,n.verified.isScam=s.isScam,n.verified.validation=origin===new URL(i.url).origin?"VALID":"INVALID")}catch(s){this.client.logger.error(s)}return this.client.logger.info(`Verify context: ${JSON.stringify(n)}`),n}}isInitialized(){if(!this.initialized){const{message:t}=R.getInternalError("NOT_INITIALIZED",this.name);throw new Error(t)}}registerRelayerEvents(){this.client.core.relayer.on(x.RELAYER_EVENTS.message,async t=>{const{topic:e,message:i}=t,{responseTopic:n,publicKey:s}=this.client.authKeys.keys.includes(I)?this.client.authKeys.get(I):{responseTopic:void 0,publicKey:void 0};if(n&&e!==n){this.client.logger.debug("[Auth] Ignoring message from unknown topic",e);return}const u=await this.client.core.crypto.decode(e,i,{receiverPublicKey:s});T.isJsonRpcRequest(u)?(this.client.core.history.set(e,u),this.onRelayEventRequest({topic:e,payload:u})):T.isJsonRpcResponse(u)&&(await this.client.core.history.resolve(u),this.onRelayEventResponse({topic:e,payload:u}))})}registerPairingEvents(){this.client.core.pairing.events.on(x.PAIRING_EVENTS.create,t=>this.onPairingCreated(t))}}class L extends Y{constructor(t){super(t),this.protocol=M,this.version=Z,this.name=j,this.events=new me.EventEmitter,this.emit=(i,n)=>this.events.emit(i,n),this.on=(i,n)=>this.events.on(i,n),this.once=(i,n)=>this.events.once(i,n),this.off=(i,n)=>this.events.off(i,n),this.removeListener=(i,n)=>this.events.removeListener(i,n),this.request=async(i,n)=>{try{return await this.engine.request(i,n)}catch(s){throw this.logger.error(s.message),s}},this.respond=async(i,n)=>{try{return await this.engine.respond(i,n)}catch(s){throw this.logger.error(s.message),s}},this.getPendingRequests=()=>{try{return this.engine.getPendingRequests()}catch(i){throw this.logger.error(i.message),i}},this.formatMessage=(i,n)=>{try{return this.engine.formatMessage(i,n)}catch(s){throw this.logger.error(s.message),s}};const e=typeof t.logger<"u"&&typeof t.logger!="string"?t.logger:P.pino(P.getDefaultLoggerOptions({level:t.logger||"error"}));this.name=t?.name||j,this.metadata=t.metadata,this.projectId=t.projectId,this.core=t.core||new x.Core(t),this.logger=P.generateChildLogger(e,this.name),this.authKeys=new x.Store(this.core,this.logger,"authKeys",N,()=>I),this.pairingTopics=new x.Store(this.core,this.logger,"pairingTopics",N),this.requests=new x.Store(this.core,this.logger,"requests",N,i=>i.id),this.engine=new wr(this)}static async init(t){const e=new L(t);return await e.initialize(),e}get context(){return P.getLoggerContext(this.logger)}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.authKeys.init(),await this.requests.init(),await this.pairingTopics.init(),await this.engine.init(),this.logger.info("AuthClient Initialization Success"),this.logger.info({authClient:this})}catch(t){throw this.logger.info("AuthClient Initialization Failure"),this.logger.error(t.message),t}}}const vr=L;exports.AUTH_CLIENT_CONTEXT=W,exports.AUTH_CLIENT_DEFAULT_NAME=j,exports.AUTH_CLIENT_PROTOCOL=M,exports.AUTH_CLIENT_PUBLIC_KEY_NAME=I,exports.AUTH_CLIENT_STORAGE_PREFIX=N,exports.AUTH_CLIENT_VERSION=Z,exports.AUTH_REQUEST_EXPIRY_BOUNDARIES=B,exports.AuthClient=vr,exports.BASE10=dr,exports.BASE16=Ce,exports.BASE64=pr,exports.DEFAULT_RPC_URL=Q,exports.ENGINE_RPC_OPTS=U,exports.EXPIRER_CONTEXT=Ue,exports.EXPIRER_DEFAULT_TTL=Se,exports.EXPIRER_EVENTS=Ne,exports.EXPIRER_STORAGE_VERSION=Oe,exports.IAuthClient=Y,exports.IAuthEngine=G,exports.UTF8=we,exports.default=L,exports.generateNonce=fr,exports.hashMessage=X;
//# sourceMappingURL=index.cjs.js.map
